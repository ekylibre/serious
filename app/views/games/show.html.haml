.container
  %h1= h('Partie ') + content_tag(:strong, @game.name)
  - if current_participation.organizer?
    - if current_participation.game.can_run?
      = link_to('Lancer la partie', run_game_path(current_participation.game), method: :post, class: 'btn btn-default')
      - current_participation.game.rebuild_turns(Time.now)
  %p= @game.description

  - if @game.current_turn and (broadcasts = @game.broadcasts.where(release_turn: @game.current_turn.number)) and broadcasts.any?
    %h2
      %i.glyphicon.glyphicon-bullhorn
      News
    #carousel.carousel.slide{data: {ride: 'carousel'}}
      %ol.carousel-indicators
        - broadcasts.size.times do |index|
          - classes = []
          - classes << 'active' if index.zero?
          %li{data: {target: '#carousel', slide_to: index}, class: classes}
      .carousel-inner
        - broadcasts.each_with_index do |broadcast, index|
          - classes = []
          - classes << 'active' if index.zero?
          .item{class: classes}
            .carousel-content
              %div
                %h4= truncate(broadcast.name, length: 90)
                %p= truncate(broadcast.content, length: 200)

      - if broadcasts.count > 1
        = link_to('#carousel', class: 'left carousel-control', data: {slide: 'prev'}) do
          %span.glyphicon.glyphicon-chevron-left

        = link_to('#carousel', class: 'right carousel-control', data: {slide: 'next'}) do
          %span.glyphicon.glyphicon-chevron-right


  - participants = @game.participants.order(:name).select{|p| current_participation.can_see?(p) }
  - if participants.any?
    %h2
      %i.glyphicon.glyphicon-briefcase
      - if current_participation.organizer?
        Participants
      - else
        Partenaires
    #participants
      - @game.participants.order(:name).each do |participant|
        - next unless current_participation.can_see?(participant)
        - classes = []
        - classes << 'with-stand' if participant.present
        .participant.box-scene{class: classes}
          - side = [:right, :left, :top, :bottom][participant.code.to_i(36).modulo(4)]
          .box{class: "hover-on-#{side}"}
            - url = {controller: participant.class.name.tableize, action: :show, id: participant.id}
            = link_to(url, class: 'participant-front face face-front') do
              - if participant.present
                .stand-number
                  = participant.stand_number
              = participant_logo(participant)
              .participant-caption
                - if current_participant and (count = current_participant.affairs_with(participant).count) and count > 0
                  %span.affairs-count
                    %span.glyphicon.glyphicon-briefcase
                    = count
                = participant.name
            = link_to(url, class: "participant-details face face-#{side}") do
              %h3= participant.name
              %span.label.label-primary= participant.class.model_name.human
              - [:contractor, :subcontractor, :supplier, :customer, :lender, :borrower, :insurer, :insured].each do |state|
                - if participant.send(state)
                  %span.label.label-success= Participant.human_attribute_name(state)


  - curves = current_game.reference_curves
  - if curves.any?
    %h2
      %i.glyphicon.glyphicon-stats
      Cours de référence
    #curves
      - current_game.reference_curves.each do |curve|
        .curve
          %h3= curve.name
          :ruby
            serie = {name: curve.name, data: curve.steps.where('turn <= ?', current_turn).order(:turn).map{|s| [s.turn , s.amount.to_s.to_f]}}
            if curve.interpolation_method_previous?
              serie[:step] = 'left'
            elsif curve.interpolation_method_following?
              serie[:step] = 'right'
            end
          .box-content= line_chart([serie],chart: {height: 150}, y_axis: {title: {text: "#{:value.tl} (#{curve.unit_name})"}})
